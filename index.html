<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reservas - Calendario</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f8f9fa; color: #333; margin: 0; padding: 20px; }
        .container { max-width: 900px; margin: 0 auto; background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        h1 { text-align: center; font-weight: 600; color: #1a73e8; }
        #calendar { margin-bottom: 20px; }
        .form-reserva { display: none; padding: 20px; border-top: 2px solid #eee; animation: fadeIn 0.5s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        input, select, button { width: 100%; padding: 12px; margin: 8px 0; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; }
        button { background-color: #1a73e8; color: white; border: none; font-weight: 600; cursor: pointer; transition: 0.3s; }
        button:hover { background-color: #1557b0; }
        .status-info { display: flex; justify-content: center; gap: 15px; font-size: 0.9em; margin-bottom: 10px; }
        .dot { height: 10px; width: 10px; border-radius: 50%; display: inline-block; }
    </style>
</head>
<body>

<div class="container">
    <h1>Reservas Online</h1>
    
    <div class="status-info">
        <span><span class="dot" style="background:#28a745"></span> Libre</span>
        <span><span class="dot" style="background:#ff9800"></span> Pendiente</span>
        <span><span class="dot" style="background:#dc3545"></span> Reservado</span>
    </div>

    <div id="calendar"></div>

    <div id="formReserva" class="form-reserva">
        <h3>Completar Reserva</h3>
        <p id="rangoSeleccionado"></p>
        <input type="text" id="nombre" placeholder="Nombre completo" required>
        <input type="number" id="personas" placeholder="NÃºmero de personas" min="1" required>
        <button onclick="enviarReserva()">Confirmar y enviar WhatsApp</button>
    </div>
</div>

<script>
    // --- CONFIGURACIÃ“N ---
    const scriptURL = 'https://script.google.com/macros/s/AKfycbyegl656mrxyeVid7gGYyVQGRdCzyrCOWLb-7xbW_D_VwkcJ1mhJkTr5o1tAcEbn5BQ/exec'; 
    const telAdministrador = '34611769813'; // Tu nÃºmero con prefijo (ej 34 para EspaÃ±a)
    
    let selectedRange = { start: '', end: '' };

    document.addEventListener('DOMContentLoaded', function() {
        const calendarEl = document.getElementById('calendar');
        const calendar = new FullCalendar.Calendar(calendarEl, {
            initialView: 'dayGridMonth',
            locale: 'es',
            selectable: true,
            headerToolbar: { left: 'prev,next', center: 'title', right: 'today' },
            
            // Cargar datos desde Google Sheets
            events: async function(info, successCallback, failureCallback) {
    try {
        const response = await fetch(scriptURL + '?t=' + new Date().getTime());
        const data = await response.json();
        
        // Transformamos los datos para que FullCalendar no se confunda
        const events = data.map(res => {
            // Aseguramos que las fechas sean texto limpio o objetos Date
            let fechaInicio = new Date(res.inicio);
            let fechaFin = new Date(res.fin);

            return {
                title: res.estado === 'Reservado' ? 'OCUPADO' : 'PENDIENTE',
                start: res.inicio.split('T')[0], end: res.fin.split('T')[0], // Probamos pasar el texto directo del Excel
                end: res.fin,
                color: res.estado === 'Reservado' ? '#dc3545' : '#ff9800',
                display: 'background',
                allDay: true
            };
        });
        
        console.log("Eventos cargados:", events); // Esto nos dirÃ¡ en la consola quÃ© estÃ¡ llegando
        successCallback(events);
    } catch (e) { 
        console.error("Error detallado:", e); 
    }
},

            // SelecciÃ³n de fechas
            select: function(info) {
                selectedRange.start = info.startStr;
                selectedRange.end = info.endStr;
                document.getElementById('formReserva').style.display = 'block';
                document.getElementById('rangoSeleccionado').innerText = `Del ${info.startStr} al ${info.endStr}`;
                window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });
            }
        });
        calendar.render();
    });

   async function enviarReserva() {
    const nombre = document.getElementById('nombre').value;
    const personas = document.getElementById('personas').value;

    if(!nombre || !personas) return alert("Por favor completa los datos");

    const datos = {
        fechaInicio: selectedRange.start,
        fechaFin: selectedRange.end,
        nombre: nombre,
        personas: personas
    };

    try {
        // 1. Guardamos en el Excel
        await fetch(scriptURL, { 
            method: 'POST', 
            mode: 'no-cors', 
            body: JSON.stringify(datos) 
        });
        
        // 2. Preparamos el mensaje de WhatsApp con tu enlace de gestiÃ³n
        const linkGestion = "https://gemayrafa.github.io/reservas-chalet/autorizar-reservas-99";
        const textoWA = `Hola! Quiero solicitar una reserva.\n\n` +
                        `ðŸ‘¤ Nombre: ${nombre}\n` +
                        `ðŸ‘¥ Personas: ${personas}\n` +
                        `ðŸ“… Fechas: del ${selectedRange.start} al ${selectedRange.end}\n\n` +
                        `ðŸ”— Gestionar aquÃ­: ${linkGestion}`;
        
        const urlWA = `https://wa.me/${telAdministrador}?text=${encodeURIComponent(textoWA)}`;

        // 3. Cambiamos la interfaz para el segundo clic (evitar bloqueo de navegador)
        const btnContainer = document.querySelector('#formReserva');
        btnContainer.innerHTML = `
            <div style="background: #e7f3ff; padding: 20px; border-radius: 12px; text-align: center; border: 1px solid #b3d7ff;">
                <p style="color: #0d47a1; font-weight: bold;">âœ… Solicitud registrada en el sistema.</p>
                <p>Para finalizar, pulsa el botÃ³n verde para enviarnos el aviso por WhatsApp:</p>
                <a href="${urlWA}" target="_blank" 
                   style="display: inline-block; background-color: #25D366; color: white; padding: 16px 30px; text-decoration: none; border-radius: 8px; font-weight: bold; font-size: 1.1em; box-shadow: 0 4px 10px rgba(37,211,102,0.3);">
                   ðŸ“± Enviar aviso por WhatsApp
                </a>
                <br><br>
                <small><a href="javascript:location.reload()" style="color: #666;">Hacer otra selecciÃ³n</a></small>
            </div>
        `;
    } catch (e) {
        alert("Hubo un error al conectar. Por favor, intÃ©ntalo de nuevo.");
    }
}
</script>

</body>
</html>