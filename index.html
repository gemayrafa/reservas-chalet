<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Reservas - Calendario</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f8f9fa; color: #333; margin: 0; padding: 10px; -webkit-tap-highlight-color: transparent; overflow-x: hidden; -webkit-text-size-adjust: 100%; }
        .container { max-width: 900px; margin: 0 auto; background: white; padding: 15px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); box-sizing: border-box; width: 100%; }
        h1 { text-align: center; font-weight: 600; color: #1a73e8; font-size: 1.5rem; }
        .btn-abrir-reserva { background: #1a73e8; color: white; border: none; padding: 15px; border-radius: 8px; width: 100%; font-size: 1.1rem; font-weight: bold; cursor: pointer; margin-bottom: 15px; box-sizing: border-box; -webkit-appearance: none; }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); align-items: center; justify-content: center; }
        .modal-content { background: white; padding: 20px; border-radius: 12px; width: 90%; max-width: 400px; box-sizing: border-box; }
        #calendar { margin-bottom: 20px; max-height: 80vh; width: 100%; }
        .form-reserva { display: none; padding: 20px; border-top: 2px solid #eee; animation: fadeIn 0.5s; width: 100%; box-sizing: border-box; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        input, button { width: 100%; padding: 12px; margin: 8px 0; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; font-size: 1rem; -webkit-appearance: none; }
        .btn-confirmar { background-color: #1a73e8; color: white; border: none; font-weight: 600; }
        .status-info { display: flex; justify-content: center; gap: 10px; font-size: 0.8em; margin-bottom: 15px; flex-wrap: wrap; }
        .dot { height: 10px; width: 10px; border-radius: 50%; display: inline-block; }
        .msg-exito { background: #e7f3ff; padding: 15px; border-radius: 12px; text-align: center; border: 1px solid #b3d7ff; width: 100%; box-sizing: border-box; }
        .btn-wa { display: inline-block; background-color: #25D366; color: white; padding: 16px 20px; text-decoration: none; border-radius: 8px; font-weight: bold; font-size: 1.1em; width: 100%; box-sizing: border-box; }
    </style>
</head>
<body>
<div class="container">
    <h1>Reservas Online</h1>
    <div class="status-info">
        <span><span class="dot" style="background:#ffffff; border: 1px solid #ddd"></span> Libre</span>
        <span><span class="dot" style="background:#ff9800"></span> Pendiente</span>
        <span><span class="dot" style="background:#dc3545"></span> Reservado</span>
    </div>
    <button class="btn-abrir-reserva" onclick="abrirModal()">ðŸ“… Seleccionar fechas para reservar</button>
    <div id="calendar"></div>
    <div id="formReserva" class="form-reserva">
        <h3>Completar Reserva</h3>
        <p id="rangoSeleccionado" style="font-weight: bold; color: #1a73e8;"></p>
        <input type="text" id="nombre" placeholder="Nombre completo" required>
        <input type="number" id="personas" placeholder="NÃºmero de personas" min="1" required>
        <button class="btn-confirmar" onclick="enviarReserva()">Confirmar y enviar WhatsApp</button>
    </div>
</div>

<div id="modalFechas" class="modal">
    <div class="modal-content">
        <h3>Elige tus fechas</h3>
        <label>Fecha de entrada:</label>
        <input type="date" id="inputInicio" onchange="actualizarPrevisualizacion()">
        <label>Fecha de salida:</label>
        <input type="date" id="inputFin" onchange="actualizarPrevisualizacion()">
        <button class="btn-confirmar" onclick="aceptarFechas()">Aceptar SelecciÃ³n</button>
        <button style="background:#666; color:white;" onclick="cerrarModal()">Cancelar</button>
    </div>
</div>

<script>
    const scriptURL = 'https://script.google.com/macros/s/AKfycbyegl656mrxyeVid7gGYyVQGRdCzyrCOWLb-7xbW_D_VwkcJ1mhJkTr5o1tAcEbn5BQ/exec'; 
    let telAdministrador = '34611769813'; 
    let selectedRange = { start: '', end: '' }; 
    let calendar;

    function formatoEuropeo(fechaStr) {
        if(!fechaStr) return "";
        const parts = fechaStr.split('-');
        return `${parts[2]}/${parts[1]}/${parts[0]}`;
    }

    document.addEventListener('DOMContentLoaded', function() {
        const calendarEl = document.getElementById('calendar');
        calendar = new FullCalendar.Calendar(calendarEl, {
            initialView: 'dayGridMonth',
            locale: 'es',
            selectable: false,
            height: 'auto',
            headerToolbar: { left: 'prev,next', center: 'title', right: 'today' },
            events: async function(info, successCallback, failureCallback) {
                try {
                    const response = await fetch(scriptURL + '?t=' + new Date().getTime());
                    const data = await response.json();
                    const events = data.map(res => {
                        let dInicio = new Date(res.inicio.split('T')[0] + "T12:00:00");
                        dInicio.setDate(dInicio.getDate() + 1);
                        let dFin = new Date(res.fin.split('T')[0] + "T12:00:00");
                        dFin.setDate(dFin.getDate() + 2); 
                        return {
                            title: res.estado === 'Reservado' ? 'RESERVADO' : 'PENDIENTE',
                            start: dInicio.toISOString().split('T')[0],
                            end: dFin.toISOString().split('T')[0],
                            backgroundColor: res.estado === 'Reservado' ? '#dc3545' : '#ff9800',
                            borderColor: 'transparent',
                            display: 'block',
                            allDay: true
                        };
                    });
                    successCallback(events);
                } catch (e) { console.error(e); }
            }
        });
        calendar.render();
    });

    function abrirModal() {
        const hoy = new Date().toISOString().split('T')[0];
        document.getElementById('inputInicio').setAttribute('min', hoy);
        document.getElementById('inputFin').setAttribute('min', hoy);
        document.getElementById('modalFechas').style.display = 'flex';
    }

    function cerrarModal() {
        document.getElementById('modalFechas').style.display = 'none';
        calendar.unselect();
    }

    function actualizarPrevisualizacion() {
        const inicio = document.getElementById('inputInicio').value;
        const fin = document.getElementById('inputFin').value;
        if (inicio) document.getElementById('inputFin').setAttribute('min', inicio);
        if (inicio && fin) {
            let dFinVisual = new Date(fin + "T12:00:00");
            dFinVisual.setDate(dFinVisual.getDate() + 1);
            calendar.select(inicio, dFinVisual.toISOString().split('T')[0]);
        }
    }

    function aceptarFechas() {
        const inicio = document.getElementById('inputInicio').value;
        const fin = document.getElementById('inputFin').value;
        if(!inicio || !fin) return alert("Selecciona fechas");
        const eventosExistentes = calendar.getEvents();
        const selIni = new Date(inicio + "T00:00:00");
        const selFin = new Date(fin + "T23:59:59");
        const estaOcupado = eventosExistentes.some(evt => (selIni < evt.end && selFin > evt.start));
        if(estaOcupado) {
            calendar.unselect();
            return alert("Error: Las fechas seleccionadas ya estÃ¡n ocupadas.");
        }
        selectedRange.start = inicio;
        selectedRange.end = fin; 
        document.getElementById('formReserva').style.display = 'block';
        document.getElementById('rangoSeleccionado').innerHTML = `Confirmado: del ${formatoEuropeo(inicio)} al ${formatoEuropeo(fin)}`;
        cerrarModal();
        setTimeout(() => document.getElementById('formReserva').scrollIntoView({ behavior: 'smooth' }), 100);
    }

    async function enviarReserva() {
        const nombre = document.getElementById('nombre').value;
        const personas = document.getElementById('personas').value;
        if(!nombre || !personas) return alert("Completa los datos");
        const btn = document.querySelector('#formReserva button');
        btn.disabled = true;
        btn.innerText = "Registrando...";
        try {
            const datos = { fechaInicio: selectedRange.start, fechaFin: selectedRange.end, nombre, personas };
            await fetch(scriptURL, { method: 'POST', mode: 'no-cors', body: JSON.stringify(datos) });
            const linkGestion = "https://gemayrafa.github.io/reservas-chalet/autorizar-reservas-99";
            const textoWA = `Hola! Quiero solicitar una reserva.\nðŸ‘¤: ${nombre}\nðŸ‘¥: ${personas}\nðŸ“…: del ${formatoEuropeo(selectedRange.start)} al ${formatoEuropeo(selectedRange.end)}\n\nðŸ”— Gestionar aquÃ­: ${linkGestion}`;
            const urlWA = `https://wa.me/${telAdministrador}?text=${encodeURIComponent(textoWA)}`;
            document.getElementById('formReserva').innerHTML = `
                <div class="msg-exito">
                    <p style="color: #0d47a1; font-weight: bold;">âœ… Solicitud registrada.</p>
                    <a href="${urlWA}" target="_blank" class="btn-wa">ðŸ“± Notificar por WhatsApp</a>
                    <br><br><small><a href="javascript:location.reload()" style="color: #666;">Cerrar y volver</a></small>
                </div>`;
        } catch (e) { alert("Error"); btn.disabled = false; }
    }
</script>
</body>
</html>